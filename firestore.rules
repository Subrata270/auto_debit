
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isSubRole(subrole) {
      return isSignedIn() && getUserData().subrole == subrole;
    }
    
    function isDepartment(department) {
      return isSignedIn() && getUserData().department == department;
    }

    // Users collection
    match /users/{userId} {
      // Allow any authenticated user to create their own document.
      // This is the most direct way to ensure registration works.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow a user to read or update their own document after creation.
      allow read, update: if isOwner(userId);
      
      // Admins can list or delete any user.
      allow list, delete: if isRole('admin');
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // An employee can create their own request.
      allow create: if isOwner(request.resource.data.requestedBy);

      // An employee can read their own dept subscriptions, HOD their dept, and finance/admin can read all.
      allow read: if (isOwner(resource.data.requestedBy) || 
                      (isRole('hod') && isDepartment(resource.data.department)) ||
                      isRole('finance') || isRole('admin'));
                      
      // Only finance or admin can list all subscriptions.
      allow list: if isRole('finance') || isRole('admin');

      // HOD can approve/decline for their department.
      // Finance APA can approve/decline for their department after HOD.
      // Finance AM can mark as active/paid.
      allow update: if (isRole('hod') && isDepartment(request.resource.data.department) && request.resource.data.status in ['Approved by HOD', 'Declined by HOD']) ||
                      (isRole('finance') && isSubRole('apa') && request.resource.data.status in ['Approved by APA', 'Declined by APA']) ||
                      (isRole('finance') && isSubRole('am') && request.resource.data.status == 'Active');
                      
      // Only admin can delete.
      allow delete: if isRole('admin');
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Allow system processes (or any signed-in user) to create notifications.
      // In a real-world scenario, this would be locked down to backend functions.
      allow create: if isSignedIn();
      
      // Users can only manage their own notifications.
      allow read, update, delete: if isOwner(resource.data.userId);
      
      // Disallow listing all notifications. Users should query their own.
      allow list: if false; 
    }
  }
}
