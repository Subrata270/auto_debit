
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isSubRole(subrole) {
      return isSignedIn() && getUserData().subrole == subrole;
    }
    
    function isDepartment(department) {
      return isSignedIn() && getUserData().department == department;
    }

    // Users collection
    match /users/{userId} {
      // Allow a user to create their own document.
      allow create: if isOwner(userId);

      // Allow a user to read or update their own document.
      allow read, update: if isOwner(userId);
      
      // Only admins can list or delete users.
      allow list, delete: if isRole('admin');
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // Employee can create their own request
      allow create: if isOwner(request.resource.data.requestedBy);

      // Employee can read their own dept subscriptions, HOD their dept, admin/finance all
      allow read: if (isOwner(resource.data.requestedBy) || 
                      (isRole('hod') && isDepartment(resource.data.department)) ||
                      isRole('finance') || isRole('admin'));
                      
      allow list: if isRole('finance') || isRole('admin');

      // HOD can approve/decline requests for their department
      allow update: if (isRole('hod') && isDepartment(request.resource.data.department) && request.resource.data.status in ['Approved by HOD', 'Declined by HOD']) ||
                      (isRole('finance') && isSubRole('apa') && request.resource.data.status in ['Approved by APA', 'Declined by APA']) ||
                      (isRole('finance') && isSubRole('am') && request.resource.data.status == 'Active');
                      
      allow delete: if isRole('admin');
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow create: if isSignedIn(); // Allow system/functions to create notifications
      allow read, update, delete: if isOwner(resource.data.userId); // Users can manage their own notifications
      allow list: if false; // Users should only be able to query their own notifications
    }
  }
}
